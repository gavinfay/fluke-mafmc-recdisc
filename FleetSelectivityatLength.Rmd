---
title: "Fleet Selectivity at Length"
author: "Sarah Gaichas"
date: "10/7/2021"
output: 
  html_document:
    code_fold: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)
```

## Convert assessment selectivity at age to selectivity at length

Mark Terciero sent the survey length weight equation parameters, selectivity info from the 2021 Summer flounder management track assessment model (ASAP), and conversions to mean length at age (file in this directory: `Summer_flounder_SVLW_SELEX_Age_Lencm.xlsx`).

>Attached is a spreadsheet with the NEFSC SV L-W equation (cm and kg) and the selectivity information from the 2021 MTA ASAP run (F2021_2019_V1.DAT).
>
>I dug out the estimated selectivities by fleet for the last time block (2008-2019) from the ASAP run, and compiled the average mean weights at age for the last 5 years.  I then used the L-W equation to calculate the associated mean lengths at age.  All of this is in the Fleet Selex tab.
>
>So - you have the selex at age by fleet and the associated mean weights and lengths at age, effectively giving the fleet selex at the fleet mean lengths.
E.g., for the Comm Land at age 4 = selex = 1.00, xwkg = 0.972, xlcm = 45.5, and so on...
>
>You/Gavin can now fit logistics, double logistics, or whatever else to get selex function at length for the four fleets.

Read in the fleet specific age based selectivities, average weight at age, and length-weight equation parameters from the sheet:

```{r}
library(tidyverse)
library(readxl)

# from https://github.com/tidyverse/readxl/issues/486#issuecomment-398224438
read_excel_multiline <- function(filename, row_collapse = 1, ...) {
  nms <- read_excel(filename, range = cell_rows(seq_len(row_collapse)), col_names = F)  
  nms <- lapply(nms, na.omit)
  nms <- lapply(nms, paste, collapse = "_")

  read_excel(filename, skip = row_collapse, col_names = unlist(nms), ...)                                     
}

# can't use the function on subsets of the sheet easily so just hardcode for sheet sections
fleetageselex.names <- read_excel("Summer_flounder_SVLW_SELEX_Age_Lencm.xlsx", sheet = "Fleet Selex", range = "A3:H4", col_names = F)
fleetageselex.names <- lapply(fleetageselex.names, na.omit)
fleetageselex.names <- lapply(fleetageselex.names, paste, collapse = "_")

fleetageselex <- read_excel("Summer_flounder_SVLW_SELEX_Age_Lencm.xlsx", sheet = "Fleet Selex", range = "A5:H12", col_names = unlist(fleetageselex.names))

fleetavgwtage.names <- read_excel("Summer_flounder_SVLW_SELEX_Age_Lencm.xlsx", sheet = "Fleet Selex", range = "A14:H15", col_names = F)
fleetavgwtage.names <- lapply(fleetavgwtage.names, na.omit)
fleetavgwtage.names <- lapply(fleetavgwtage.names, paste, collapse = "_")
  
fleetavgwtage <- read_excel("Summer_flounder_SVLW_SELEX_Age_Lencm.xlsx", sheet = "Fleet Selex", range = "A16:H23", col_names = unlist(fleetavgwtage.names))

# W (kg) = a*L(cm)^b
lenwt_a <- read_excel("Summer_flounder_SVLW_SELEX_Age_Lencm.xlsx", 
                      sheet = "Fleet Selex", 
                      range = "J13",
                      col_names=FALSE)[[1]]
lenwt_b <- read_excel("Summer_flounder_SVLW_SELEX_Age_Lencm.xlsx", 
                      sheet = "Fleet Selex", 
                      range = "K13",
                      col_names=FALSE)[[1]]


```

Get mean length at age from weights at age for each fleet and align with age specific selectivities:

```{r}

fleetwtage <- fleetavgwtage %>%
  dplyr::rename_all(make.names) %>%
  dplyr::select(Age = 'Comm.Land_Age', matches('XWkg'))
  
# could also join with a more general survey average wt at age instead
# or back out from age-length relationship
# using assessment avgwtage by fleet for now

fleetselex <- fleetageselex %>%
  dplyr::rename_all(make.names) %>%
  dplyr::select(Age = 'Comm.Land_Age', matches('Selex')) %>%
  dplyr::left_join(fleetwtage) %>%
  tidyr::pivot_longer(
    cols = -Age,
    names_to = c("Fleet", "Variable"),
    names_sep = "_",
    values_to = "Value"
  ) %>%
  tidyr::pivot_wider(names_from = "Variable", 
                     values_from = "Value") %>%
  dplyr::mutate(XLcm = exp((log(XWkg)-log(lenwt_a))/lenwt_b))
  
  
ggplot2::ggplot(fleetselex, aes(x=XLcm, y=Selex.prop.)) + 
  geom_point() + 
  facet_grid(~Fleet) + 
  xlab("mean length (cm)") +
  ylab("proportion selected")


```

Sinatra is using 2 cm length bins from (lower limit) 10 to 92 cm.

I think we will need to make a decision about the extent of domed selectivity for the larger sizes if we fit a function to this, or we can just do linear interpolation and hold the ends steady since it is an input vector of starting values rather than a set of function parameters.

Import things from the ASAP dat file for Sinatra using a handy function [`wham::read_asa3_dat()`](https://github.com/timjmiller/wham/blob/master/R/read_asap3_dat.R):
```{r}
#library(r4ss)
#devtools::install_github("timjmiller/wham") #WHAM install failing
#library(wham) 
# this is the function from WHAM I want
# https://github.com/timjmiller/wham/blob/master/R/read_asap3_dat.R

read_asap3_dat <- function(filename){
  char.lines <- readLines(filename)
  com.ind <- which(substring(char.lines,1,1) == "#")
  #print(com.ind)
  dat.start <- com.ind[c(which(diff(com.ind)>1), length(com.ind))]
  comments <- char.lines[dat.start]
  #print(comments)
  #print(dat.start)
  #print(length(dat.start))
  dat <- list()
  ind <- 0
  dat$n_years <- scan(filename, quiet=T, what = integer(), skip = dat.start[ind <- ind + 1], n = 1)
  dat$year1 <- scan(filename, quiet=T, what = integer(), skip = dat.start[ind <- ind + 1], n = 1)
  dat$n_ages <- scan(filename, quiet=T, what = integer(), skip = dat.start[ind <- ind + 1], n = 1)
  dat$n_fleets <- scan(filename, quiet=T, what = integer(), skip = dat.start[ind <- ind + 1], n = 1)
  #print(dat)
  #print(ind)
  dat$n_fleet_sel_blocks <- scan(filename, quiet=T, what = integer(), skip = dat.start[ind <- ind + 1], n = 1)
  dat$n_indices <- scan(filename, quiet=T, what = integer(), skip = dat.start[ind <- ind + 1], n = 1)

  dat$M <- matrix(scan(filename, quiet=T, what = double(), skip = dat.start[ind <- ind + 1], n = dat$n_years*dat$n_ages), dat$n_years, dat$n_ages, byrow = TRUE)
  dat$fec_opt <- scan(filename, quiet=T, what = integer(), skip = dat.start[ind <- ind + 1], n = 1)
  dat$fracyr_spawn <- scan(filename, quiet=T, what = double(), skip = dat.start[ind <- ind + 1], n = 1)
  dat$maturity <- matrix(scan(filename, quiet=T, what = double(), skip = dat.start[ind <- ind + 1], n = dat$n_years*dat$n_ages), dat$n_years, dat$n_ages, byrow = TRUE)
  dat$n_WAA_mats <- scan(filename, quiet=T, what = integer(), skip = dat.start[ind <- ind + 1], n = 1)
  dat$WAA_mats <- lapply(1:dat$n_WAA_mats, function(x) matrix(scan(filename, quiet=T, what = double(), skip = dat.start[ind+x], n = dat$n_years*dat$n_ages), dat$n_years, dat$n_ages, byrow = TRUE))

  ind <- ind+dat$n_WAA_mats
  npt <- dat$n_fleets * 2 + 2 + 2
  dat$WAA_pointers <- sapply(1:npt, function(x) scan(filename, quiet=T, what = integer(), skip = dat.start[ind+1]+x-1, n = 1))
  ind <- ind + 1
  # print(ind)

  dat$sel_block_assign <- lapply(1:dat$n_fleets, function(x) scan(filename, quiet=T, what = integer(), skip = dat.start[ind+x], n = dat$n_years))
  ind <- ind+dat$n_fleets
  dat$sel_block_option <- scan(filename, quiet=T, what = integer(), skip = dat.start[ind <- ind + 1], n = dat$n_fleet_sel_blocks)
  # print(ind)
  # print(dat.start[ind])
  dat$sel_ini <- lapply(1:dat$n_fleet_sel_blocks, function(x) matrix(scan(filename, quiet=T, what = double(), skip = dat.start[ind+x], n = 4*(dat$n_ages+6)), dat$n_ages+6, 4, byrow = TRUE))
  ind <- ind + dat$n_fleet_sel_blocks
  dat$fleet_sel_start_age <- scan(filename, quiet=T, what = integer(), skip = dat.start[ind <- ind + 1], n = dat$n_fleets)
  dat$fleet_sel_end_age <- scan(filename, quiet=T, what = integer(), skip = dat.start[ind <- ind + 1], n = dat$n_fleets)
  dat$Frep_ages <- scan(filename, quiet=T, what = integer(), skip = dat.start[ind <- ind + 1], n = 2)
  dat$Frep_type <- scan(filename, quiet=T, what = integer(), skip = dat.start[ind <- ind + 1], n = 1)
  dat$use_like_const <- scan(filename, quiet=T, what = integer(), skip = dat.start[ind <- ind + 1], n = 1)
  dat$release_mort <- scan(filename, quiet=T, what = double(), skip = dat.start[ind <- ind + 1], n = dat$n_fleets)

  dat$CAA_mats <- lapply(1:dat$n_fleets, function(x) matrix(scan(filename, quiet=T, what = double(), skip = dat.start[ind+x], n = dat$n_years*(dat$n_ages+1)), dat$n_years, dat$n_ages+1, byrow = TRUE))
  ind <- ind + dat$n_fleets
  dat$DAA_mats <- lapply(1:dat$n_fleets, function(x) matrix(scan(filename, quiet=T, what = double(), skip = dat.start[ind+x], n = dat$n_years*(dat$n_ages+1)), dat$n_years, dat$n_ages+1, byrow = TRUE))
  ind <- ind + dat$n_fleets
  dat$prop_rel_mats <- lapply(1:dat$n_fleets, function(x) matrix(scan(filename, quiet=T, what = double(), skip = dat.start[ind+x], n = dat$n_years*(dat$n_ages)), dat$n_years, dat$n_ages, byrow = TRUE))
  ind <- ind + dat$n_fleets
  # print(ind)

  dat$index_units <- scan(filename, quiet=T, what = integer(), skip = dat.start[ind <- ind + 1], n = dat$n_indices)
  dat$index_acomp_units <- scan(filename, quiet=T, what = integer(), skip = dat.start[ind <- ind + 1], n = dat$n_indices)
  dat$index_WAA_pointers <- scan(filename, quiet=T, what = integer(), skip = dat.start[ind <- ind + 1], n = dat$n_indices)
  dat$index_month <- scan(filename, quiet=T, what = double(), skip = dat.start[ind <- ind + 1], n = dat$n_indices)
  dat$index_sel_choice <- scan(filename, quiet=T, what = integer(), skip = dat.start[ind <- ind + 1], n = dat$n_indices)
  dat$index_sel_option <- scan(filename, quiet=T, what = integer(), skip = dat.start[ind <- ind + 1], n = dat$n_indices)
  dat$index_sel_start_age <- scan(filename, quiet=T, what = integer(), skip = dat.start[ind <- ind + 1], n = dat$n_indices)
  dat$index_sel_end_age <- scan(filename, quiet=T, what = integer(), skip = dat.start[ind <- ind + 1], n = dat$n_indices)
  dat$use_index_acomp <- scan(filename, quiet=T, what = integer(), skip = dat.start[ind <- ind + 1], n = dat$n_indices)
  dat$use_index <- scan(filename, quiet=T, what = integer(), skip = dat.start[ind <- ind + 1], n = dat$n_indices)
  dat$index_sel_ini <- lapply(1:dat$n_indices, function(x) matrix(scan(filename, quiet=T, what = double(), skip = dat.start[ind+x], n = 4*(dat$n_ages+6)), dat$n_ages+6, 4, byrow = TRUE))
  ind <- ind + dat$n_indices
  # print(dat$n_indices)
  #stop()
  # print(dat$index_sel_ini)
  dat$IAA_mats <- lapply(1:dat$n_indices, function(x) matrix(scan(filename, quiet=T, what = double(), skip = dat.start[ind+x], n = dat$n_years*(dat$n_ages+4)), dat$n_years, dat$n_ages+4, byrow = TRUE))
  ind <- ind + dat$n_indices
  # print(ind)

  dat$phase_F1 <- scan(filename, quiet=T, what = integer(), skip = dat.start[ind <- ind + 1], n = 1)
  dat$phase_F_devs <- scan(filename, quiet=T, what = integer(), skip = dat.start[ind <- ind + 1], n = 1)
  dat$phase_rec_devs <- scan(filename, quiet=T, what = integer(), skip = dat.start[ind <- ind + 1], n = 1)
  dat$phase_N1_devs <- scan(filename, quiet=T, what = integer(), skip = dat.start[ind <- ind + 1], n = 1)
  dat$phase_q <- scan(filename, quiet=T, what = integer(), skip = dat.start[ind <- ind + 1], n = 1)
  dat$phase_q_devs <- scan(filename, quiet=T, what = integer(), skip = dat.start[ind <- ind + 1], n = 1)
  dat$phase_SR_scalar <- scan(filename, quiet=T, what = integer(), skip = dat.start[ind <- ind + 1], n = 1)
  dat$phase_steepness <- scan(filename, quiet=T, what = integer(), skip = dat.start[ind <- ind + 1], n = 1)
  dat$recruit_cv <- scan(filename, quiet=T, what = double(), skip = dat.start[ind <- ind + 1], n = dat$n_years)

  dat$lambda_index <- scan(filename, quiet=T, what = double(), skip = dat.start[ind <- ind + 1], n = dat$n_indices)
  dat$lambda_catch <- scan(filename, quiet=T, what = double(), skip = dat.start[ind <- ind + 1], n = dat$n_fleets)
  dat$lambda_discard <- scan(filename, quiet=T, what = double(), skip = dat.start[ind <- ind + 1], n = dat$n_fleets)

  dat$catch_cv <- matrix(scan(filename, quiet=T, what = double(), skip = dat.start[ind <- ind + 1], n = dat$n_years*dat$n_fleets), dat$n_years, dat$n_fleets, byrow = TRUE)
  dat$discard_cv <- matrix(scan(filename, quiet=T, what = double(), skip = dat.start[ind <- ind + 1], n = dat$n_years*dat$n_fleets), dat$n_years, dat$n_fleets, byrow = TRUE)
  dat$catch_Neff <- matrix(scan(filename, quiet=T, what = double(), skip = dat.start[ind <- ind + 1], n = dat$n_years*dat$n_fleets), dat$n_years, dat$n_fleets, byrow = TRUE)
  dat$discard_Neff <- matrix(scan(filename, quiet=T, what = double(), skip = dat.start[ind <- ind + 1], n = dat$n_years*dat$n_fleets), dat$n_years, dat$n_fleets, byrow = TRUE)
  # print(ind)

  dat$lambda_F1 <- scan(filename, quiet=T, what = double(), skip = dat.start[ind <- ind + 1], n = dat$n_fleets)
  dat$cv_F1 <- scan(filename, quiet=T, what = double(), skip = dat.start[ind <- ind + 1], n = dat$n_fleets)
  dat$lambda_F_devs <- scan(filename, quiet=T, what = double(), skip = dat.start[ind <- ind + 1], n = dat$n_fleets)
  dat$cv_F_devs <- scan(filename, quiet=T, what = double(), skip = dat.start[ind <- ind + 1], n = dat$n_fleets)

  dat$lambda_N1_devs <- scan(filename, quiet=T, what = double(), skip = dat.start[ind <- ind + 1], n = 1)
  dat$cv_N1_devs <- scan(filename, quiet=T, what = double(), skip = dat.start[ind <- ind + 1], n = 1)
  dat$lambda_rec_devs <- scan(filename, quiet=T, what = double(), skip = dat.start[ind <- ind + 1], n = 1)

  dat$lambda_q <- scan(filename, quiet=T, what = double(), skip = dat.start[ind <- ind + 1], n = dat$n_indices)
  dat$cv_q <- scan(filename, quiet=T, what = double(), skip = dat.start[ind <- ind + 1], n = dat$n_indices)

  dat$lambda_q_devs <- scan(filename, quiet=T, what = double(), skip = dat.start[ind <- ind + 1], n = dat$n_indices)
  dat$cv_q_devs <- scan(filename, quiet=T, what = double(), skip = dat.start[ind <- ind + 1], n = dat$n_indices)

  dat$lambda_steepness <- scan(filename, quiet=T, what = double(), skip = dat.start[ind <- ind + 1], n = 1)
  dat$cv_steepness <- scan(filename, quiet=T, what = double(), skip = dat.start[ind <- ind + 1], n = 1)

  dat$lambda_SR_scalar <- scan(filename, quiet=T, what = double(), skip = dat.start[ind <- ind + 1], n = 1)
  dat$cv_SR_scalar <- scan(filename, quiet=T, what = double(), skip = dat.start[ind <- ind + 1], n = 1)
  # print(ind)

  dat$N1_flag <- scan(filename, quiet=T, what = integer(), skip = dat.start[ind <- ind + 1], n = 1)
  dat$N1_ini <- scan(filename, quiet=T, what = double(), skip = dat.start[ind <- ind + 1], n = dat$n_ages)
  dat$F1_ini <- scan(filename, quiet=T, what = double(), skip = dat.start[ind <- ind + 1], n = dat$n_fleets)
  dat$q_ini <- scan(filename, quiet=T, what = double(), skip = dat.start[ind <- ind + 1], n = dat$n_indices)
  dat$SR_scalar_type <- scan(filename, quiet=T, what = integer(), skip = dat.start[ind <- ind + 1], n = 1)
  dat$SR_scalar_ini <- scan(filename, quiet=T, what = double(), skip = dat.start[ind <- ind + 1], n = 1)
  dat$steepness_ini <- scan(filename, quiet=T, what = double(), skip = dat.start[ind <- ind + 1], n = 1)
  dat$Fmax <- scan(filename, quiet=T, what = double(), skip = dat.start[ind <- ind + 1], n = 1)
  dat$ignore_guesses <- scan(filename, quiet=T, what = integer(), skip = dat.start[ind <- ind + 1], n = 1)
  # print(ind)

  dat$do_proj <- scan(filename, quiet=T, what = integer(), skip = dat.start[ind <- ind + 1], n = 1)
  dat$dir_fleet <- scan(filename, quiet=T, what = integer(), skip = dat.start[ind <- ind + 1], n = dat$n_fleets)
  dat$nfinalyear <- scan(filename, quiet=T, what = integer(), skip = dat.start[ind <- ind + 1], n = 1)
  n <- dat$nfinalyear-dat$year1-dat$n_years+1
  # print(n)
  # print(ind)
  # print(dat.start[ind])
  if(n>0) dat$proj_ini <- matrix(scan(filename, quiet=T, what = double(), skip = dat.start[ind <- ind + 1], n = n*5), n, 5, byrow = TRUE)
  else dat$proj_ini <- matrix(nrow = 0, ncol = 5)
  dat$doMCMC <- scan(filename, quiet=T, what = integer(), skip = dat.start[ind <- ind + 1], n = 1)
  dat$MCMC_nyear_opt <- scan(filename, quiet=T, what = integer(), skip = dat.start[ind <- ind + 1], n = 1)
  dat$MCMC_nboot <- scan(filename, quiet=T, what = integer(), skip = dat.start[ind <- ind + 1], n = 1)
  dat$MCMC_nthin <- scan(filename, quiet=T, what = integer(), skip = dat.start[ind <- ind + 1], n = 1)
  dat$MCMC_nseed <- scan(filename, quiet=T, what = integer(), skip = dat.start[ind <- ind + 1], n = 1)
  dat$fill_R_opt <- scan(filename, quiet=T, what = integer(), skip = dat.start[ind <- ind + 1], n = 1)
  dat$R_avg_start <- scan(filename, quiet=T, what = integer(), skip = dat.start[ind <- ind + 1], n = 1)
  dat$R_avg_end <- scan(filename, quiet=T, what = integer(), skip = dat.start[ind <- ind + 1], n = 1)
  dat$make_R_file <- scan(filename, quiet=T, what = integer(), skip = dat.start[ind <- ind + 1], n = 1)
  dat$testval <- scan(filename, quiet=T, what = integer(), skip = dat.start[ind <- ind + 1], n = 1)
  # print(dat$testval)
  # print(ind)
  return(list(dat = dat, comments = comments))
}

asapinput <- read_asap3_dat("benchmark_files/F2021_2019_V1_MCMC.dat")

```

ASAP has annual weight at age for different fleets and indices, but the Sinatra input is mean weight at age at the beginning of the year and mid year (presumably in the population).

I've replaced the Sinatra L-W equation parameters at lines 76-77 with those received from Mark:
lenwt_a `r lenwt_a`
lenwt_b `r lenwt_b`

We could just use the L-W equation parameters to translate Sinatra mean length at age to mean weight at age for compatibility. 

